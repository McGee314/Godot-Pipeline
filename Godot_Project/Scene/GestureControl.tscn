[gd_scene load_steps=4 format=3 uid="uid://daneyolpvha5n"]

[ext_resource type="PackedScene" uid="uid://dyapqblkrqmi6" path="res://Models/Dji Tello 3D Model.glb" id="1_7kahk"]

[sub_resource type="PlaneMesh" id="PlaneMesh_ground"]

[sub_resource type="GDScript" id="GDScript_q1mfu"]
script/source = "extends Node

# UDP Configuration
var udp := PacketPeerUDP.new()
var listen_port := 9999  # Port untuk menerima gesture dari Python
var is_listening := false

# Gesture state
var current_gesture := \"NO_HAND\"
var last_gesture_time := 0.0

# Reference to the object to control (e.g., drone)
@export var controlled_object: Node3D

# Movement settings
@export var move_speed := 5.0  # Speed of movement
@export var smooth_movement := true
@export var movement_scale := 1.0  # Scale for movement amount

# Debug
@export var show_debug := true

func _ready():
	print(\"ðŸŽ® Gesture Receiver Initialized\")
	
	# Start listening for UDP gestures
	var err = udp.bind(listen_port)
	if err != OK:
		push_error(\"âŒ Failed to bind UDP port %d: %s\" % [listen_port, error_string(err)])
		is_listening = false
	else:
		print(\"âœ… Listening for gestures on UDP port: \", listen_port)
		is_listening = true
	
	# Find controlled object if not set
	if not controlled_object:
		# Try to find the drone or any child with \"Sketchfab_Scene\" name
		controlled_object = get_node_or_null(\"../Sketchfab_Scene\")
		if controlled_object:
			print(\"âœ… Auto-detected controlled object: \", controlled_object.name)
		else:
			push_warning(\"âš ï¸ No controlled object set. Please assign in inspector.\")

func _process(delta):
	if not is_listening:
		return
	
	# Check for incoming packets
	while udp.get_available_packet_count() > 0:
		var packet = udp.get_packet()
		var message = packet.get_string_from_utf8()
		
		# Parse JSON
		var json = JSON.new()
		var error = json.parse(message)
		
		if error == OK:
			var data = json.data
			if typeof(data) == TYPE_DICTIONARY and data.has(\"type\") and data[\"type\"] == \"gesture\":
				handle_gesture(data[\"gesture\"])
		else:
			if show_debug:
				print(\"âš ï¸ Failed to parse JSON: \", message)

func handle_gesture(gesture: String):
	\"\"\"Handle incoming gesture and move the controlled object\"\"\"
	if not controlled_object:
		return
	
	current_gesture = gesture
	last_gesture_time = Time.get_ticks_msec() / 1000.0
	
	if show_debug and gesture != \"CENTER\" and gesture != \"NO_HAND\":
		print(\"ðŸ‘‹ Gesture received: \", gesture)
	
	# Calculate movement vector based on gesture
	var movement := Vector3.ZERO
	
	match gesture:
		\"UP\":
			movement = Vector3(0, 0, -1) * move_speed * movement_scale
		\"DOWN\":
			movement = Vector3(0, 0, 1) * move_speed * movement_scale
		\"LEFT\":
			movement = Vector3(-1, 0, 0) * move_speed * movement_scale
		\"RIGHT\":
			movement = Vector3(1, 0, 0) * move_speed * movement_scale
		\"CENTER\", \"NO_HAND\":
			movement = Vector3.ZERO
	
	# Apply movement
	if movement != Vector3.ZERO:
		if smooth_movement:
			# Smooth movement using delta
			controlled_object.global_position += movement * get_process_delta_time()
		else:
			# Instant movement (step-based)
			controlled_object.global_position += movement * 0.1

func _notification(what):
	if what == NOTIFICATION_PREDELETE:
		# Cleanup UDP socket
		if udp:
			udp.close()
		print(\"ðŸ‘‹ Gesture Receiver closed\")

# Helper functions for external control
func get_current_gesture() -> String:
	return current_gesture

func set_controlled_object(obj: Node3D):
	controlled_object = obj
	print(\"âœ… Controlled object set to: \", obj.name if obj else \"null\")

func set_move_speed(speed: float):
	move_speed = speed

func get_time_since_last_gesture() -> float:
	return (Time.get_ticks_msec() / 1000.0) - last_gesture_time
"

[node name="GestureControlScene" type="Node3D"]

[node name="Ground" type="MeshInstance3D" parent="."]
transform = Transform3D(20, 0, 0, 0, 20, 0, 0, 0, 20, 0, 0, 0)
mesh = SubResource("PlaneMesh_ground")

[node name="GestureReceiver" type="Node" parent="."]
script = SubResource("GDScript_q1mfu")
controlled_object = NodePath("")

[node name="Camera3D" type="Camera3D" parent="."]
transform = Transform3D(1, 0, 0, 0, 0.866025, 0.5, 0, -0.5, 0.866025, 0, 8, 12)
fov = 60.0

[node name="DirectionalLight3D" type="DirectionalLight3D" parent="."]
transform = Transform3D(1, 0, 0, 0, -0.422618, 0.906308, 0, -0.906308, -0.422618, 0, 10, 0)
shadow_enabled = true

[node name="StatusLabel" type="Label" parent="."]
offset_left = 20.0
offset_top = 20.0
offset_right = 400.0
offset_bottom = 80.0
text = "ðŸŽ® Hand Gesture Control
Waiting for gestures..."
vertical_alignment = 1

[node name="InfoLabel" type="Label" parent="."]
offset_left = 20.0
offset_top = 100.0
offset_right = 400.0
offset_bottom = 200.0
text = "ðŸ“¡ Listening on UDP port 9999
ðŸ‘‹ Move your hand to control the drone:
   â€¢ UP - Move Forward
   â€¢ DOWN - Move Backward
   â€¢ LEFT - Move Left
   â€¢ RIGHT - Move Right"

[node name="DJI Tello" parent="." instance=ExtResource("1_7kahk")]
transform = Transform3D(1, 0, 0, 0, 1, 0, 0, 0, 1, 0.824005, 4.67841, -35.1238)
